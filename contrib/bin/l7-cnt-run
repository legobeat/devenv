#!/bin/bash
# proxy command to run in ephemeral sibling container
# expects a container engine socket on $CONTAINER_HOST

RUNNER_IMAGE="${RUNNER_IMAGE:-${NODE_RUNNER_IMAGE}}"

if [[ "$(basename $0)" = "l7-cnt-run" ]]; then
  COMMAND="$1"
  ARGS="${@:2}"
else
  COMMAND="$(basename $0)"
  ARGS="${@}"
fi

[[ -n "$DEBUG" ]] && set -x

if [ -n "${RUNNER_ENV}"  ]; then
  for e in ${RUNNER_ENV}; do
    export RUNNER_OPTS="${RUNNER_OPTS} -e ${e}"
  done
fi
if [ -n "${RUNNER_PORTS}"  ]; then
  for ports in ${RUNNER_PORTS}; do
    export RUNNER_OPTS="${RUNNER_OPTS} -p ${ports}"
  done
fi
if [ -n "${RUNNER_VOLS}"  ]; then
  for vol in ${RUNNER_VOLS}; do
    export RUNNER_OPTS="${RUNNER_OPTS} -v ${vol}"
  done
fi

# remove any GITHUB_TOKEN, NPM_TOKEN, etc from env vars automatically propagated
for tokenvar in $(env | cut -d= -f1 | grep -i _token); do
  [[ -n "${DEBUG}" ]] && echo "Removing potentially sensitive env var ${tokenvar} from process. You can set it explicitly via RUNNER_ENV".
  unset "${tokenvar}";
done

sudo -E \
  podman run --rm -it \
  --user "$(id -u):$(id -g)" --userns=keep-id:uid=$(id -u),gid=$(id -g) \
  -e NODE_OPTIONS="${NODE_OPTIONS}" \
  -e '*' \
  -e "HOME=/home/node" \
  -e "PATH=/home/node/.corepack/bin:/usr/local/lib/node_modules/.bin:/usr/local/lib/node_modules/corepack/shims:/home/node/.rbenv/shims:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" \
  -v "${SRC_DIR}:${SRC_DIR}" -v "${SRC_DIR}:/src" -w "${PWD}" \
  ${RUNNER_OPTS} \
  --entrypoint "${COMMAND}" -- $RUNNER_IMAGE ${ARGS}
