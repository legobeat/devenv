#!/bin/bash
# proxy command to run in ephemeral sibling container
# expects a container engine socket on $CONTAINER_HOST

if [[ "$(basename $0)" = "l7-cnt-run" ]]; then
  COMMAND="$1"
  ARGS="${@:2}"
else
  COMMAND="$(basename $0)"
  ARGS="${@}"
fi

[[ -n "$DEBUG" ]] && set -x

if [ -n "${RUNNER_ENV}"  ]; then
  for e in ${RUNNER_ENV}; do
    export RUNNER_OPTS="${RUNNER_OPTS} -e ${e}"
  done
fi
if [ -n "${RUNNER_PORTS}"  ]; then
  for ports in ${RUNNER_PORTS}; do
    export RUNNER_OPTS="${RUNNER_OPTS} -p ${ports}"
  done
fi
if [ -n "${RUNNER_VOLS}"  ]; then
  for vol in ${RUNNER_VOLS}; do
    export RUNNER_OPTS="${RUNNER_OPTS} -v ${vol}"
  done
fi

# remove any GITHUB_TOKEN, NPM_TOKEN, etc from env vars automatically propagated
for tokenvar in $(env | cut -d= -f1 | grep -i _token); do
  [[ -n "${DEBUG}" ]] && echo "Removing potentially sensitive env var ${tokenvar} from process. You can set it explicitly via RUNNER_ENV".
  unset "${tokenvar}";
done

sudo -E \
  podman run --rm -i \
  --user "$(id -u):$(id -g)" --userns=keep-id:uid=$(id -u),gid=$(id -g) \
  -e '*' \
  --network "${L7_COMPOSE_NETWORK_NAME_INTERNAL}" \
  -v "${SRC_DIR}:${SRC_DIR}" -v "${SRC_DIR}:/src" -w "${PWD}" \
  -v "${L7_RESOLV_CONF_PATH}:/etc/resolv.conf:ro" \
  ${RUNNER_OPTS} \
  --entrypoint "${COMMAND}" -- $RUNNER_IMAGE ${ARGS}
