#!/bin/bash

is_react_native_project() {
  # TODO: look at git root as well as pwd
  if [[ -n "${BUILD_ANDROID}" ]] || [[ -n "${BUILD_IOS}" ]] || [[ -f ios/Podfile ]] ||  [[ -f Podfile ]]; then
    return 0
  fi
  return -1
}

# TODO: figure out some nice mechanism for unifying/selecting right image for android/ios in react native projects...
if is_react_native_project;  then
  export RUNNER_IMAGE=${RUNNER_IMAGE:-${BUNDLER_RUNNER_IMAGE:-localhost/l7/node:android-bookworm}}
  if [ -n "${BUILD_IOS}" ]; then
    export RUNNER_IMAGE=${RUNNER_IMAGE:-${BUNDLER_RUNNER_IMAGE:-localhost/l7/node:ios-bookworm}}
  else
    if [[ -n "${L7_NODE_CACHE_DIR}" ]]; then
      export RUNNER_VOLS="${L7_NODE_CACHE_DIR}/android/cache:/home/user/.android/cache ${RUNNER_VOLS}"
      export RUNNER_VOLS="${L7_NODE_CACHE_DIR}/gradle/caches:/home/user/.gradle/caches ${RUNNER_VOLS}"
    else
      if [[ -n "${L7_ANDROID_CACHE_VOLUME}" ]]; then
        export RUNNER_VOLS="${L7_ANDROID_CACHE_VOLUME}:/home/user/.android/cache ${RUNNER_VOLS}"
      fi
      if [[ -n "${L7_GRADLE_CACHE_VOLUME}" ]]; then
        export RUNNER_VOLS="${L7_GRADLE_CACHE_VOLUME}:/home/user/.gradle/caches ${RUNNER_VOLS}"
      fi
    fi
  fi
else
  export RUNNER_IMAGE="${RUNNER_IMAGE:-${NODE_RUNNER_IMAGE:-localhost/l7/node}}"
fi

if [[ "${RUNNER_IMAGE}" != *:* ]]; then
  export RUNNER_IMAGE=${RUNNER_IMAGE}:${L7_NODE_VERSION:-20}-bookworm
fi

export RUNNER_ENV="${RUNNER_ENV}
ADB_SERVER_SOCKET=${L7_ADB_SERVER_SOCKET:-tcp:10.7.8.140:5037}
NODE_OPTIONS=${NODE_OPTIONS}
HOME=/home/user
PATH=/home/user/.corepack/bin:/home/user/.npm-global/bin:/usr/local/lib/node_modules/.bin:/usr/local/lib/node_modules/corepack/shims:/home/user/Android/Sdk/platform-tools:/home/user/.rbenv/shims:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
"

if [ -n "${NODE_OPTIONS}" ]; then
  export RUNNER_ENV="${RUNNER_ENV}
NODE_OPTIONS=${NODE_OPTIONS}"
fi

if [[ "$(basename $0)" = "l7-run-node" ]]; then
  COMMAND="$1"
  ARGS="${@:2}"
else
  COMMAND="$(basename $0)"
  ARGS="${@}"
fi

exec l7-cnt-run "${COMMAND}" ${ARGS}
