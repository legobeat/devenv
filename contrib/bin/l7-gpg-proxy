#!/bin/bash
export RUNNER_IMAGE=${GPG_IMAGE:-${RUNNER_IMAGE}}

GPG_RUNNER_ENTRYPOINT="${GPG_RUNNER_ENTRYPOINT:-gpg}"

[[ -n "${DEBUG}" ]] && set -x

# mount/volume source path on host despite run command being run in container
sudo -E podman run --rm \
  -i \
  --name l7-gpg \
  --stop-signal 9 --stop-timeout=3 \
  -e GNUPGHOME=/vault/gnupg \
  --entrypoint "${GPG_RUNNER_ENTRYPOINT}" \
  --mount type=volume,source=l7-gpg-vault-pk,target=/vault/gnupg \
  -v /run/user/$(id -u)/gnupg:/run/user/0/gnupg:ro \
  -v /run/user/1000/gnupg/S.gpg-agent:/vault/gnupg/S.gpg-agent \
  ${GPG_RUNNER_OPTS} \
  localhost/l7/gpg-vault:pk \
  ${@}
